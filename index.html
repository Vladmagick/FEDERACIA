```html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–§–ï–î–ï–†–ê–¶–ò–Ø</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(180deg,#0b0f17,#0f172a);
      color:#fff;
      min-height:100vh;
      overflow-x:hidden;
    }

    .app{
      max-width:430px;
      margin:0 auto;
      padding:20px 16px 110px;
    }

    h1{font-size:22px;font-weight:600;margin-bottom:16px}

    .card{ background:rgba(255,255,255,0.06); backdrop-filter:blur(25px); border-radius:24px; padding:18px; margin-bottom:16px; box-shadow:0 15px 40px rgba(0,0,0,0.5); transition:0.25s ease;}
    .card:active{transform:scale(0.97)}

    input,textarea,select{ width:100%; margin-top:10px; padding:12px; border-radius:16px; border:none; background:rgba(255,255,255,0.08); color:#fff; }
    button{ margin-top:12px; padding:12px; border-radius:18px; border:none; background:rgba(255,255,255,0.1); color:#fff; transition:0.2s; }
    button:active{transform:scale(0.96)}
    canvas{width:100%;height:200px;cursor:pointer}
    .hidden{display:none}
    .green{color:#00ff9d}
    .orange{color:#ff9d00}
    .red{color:#ff4d4d}

    /* ===== TELEGRAM DOCK (volume glass) ===== */
    .bottom-dock{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; width:92%; max-width:430px; height:76px; border-radius:38px; background:rgba(20,24,32,0.62); backdrop-filter:blur(30px); display:flex; justify-content:space-around; align-items:center;
      box-shadow: 0 18px 50px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.10), inset 0 -1px 0 rgba(0,0,0,0.35);
      border:1px solid rgba(255,255,255,0.07); z-index:999;
    }
    .dock-item{ width:72px; height:60px; border-radius:22px; display:flex; flex-direction:column; align-items:center; justify-content:center; color:rgba(255,255,255,0.58); font-size:11px; gap:3px; transition: transform .35s cubic-bezier(.2,.8,.2,1), color .25s ease, background .25s ease; position:relative; user-select:none; }
    .dock-item .dock-icon{ font-size:20px; line-height:20px; transition: transform .35s cubic-bezier(.2,.8,.2,1); }
    .dock-item.active{ color:#00ff9d; transform: translateY(-7px); }
    .dock-item.active::before{ content:""; position:absolute; inset:6px; border-radius:18px; background:rgba(0,255,157,0.10); box-shadow:0 0 26px rgba(0,255,157,0.38); z-index:-1; }
    .dock-item:active{ transform: translateY(-6px) scale(0.96); }
    .dock-item:active .dock-icon{ transform: scale(0.90); }

    /* ===== Screen animation base ===== */
    .app > div{ transition: opacity .30s ease, transform .30s ease; will-change: opacity, transform; }
    .calendar-day{ display:inline-block; width:42px;height:42px; line-height:42px; text-align:center; margin:4px; border-radius:12px; background:rgba(255,255,255,0.06); font-size:13px; }
    .calendar-day.marked{background:#00ff9d;color:#000}

    /* ===== STATIC SCREENS MODE (NO JUMP) ===== */
    html, body{ height:100%; overflow:hidden; overscroll-behavior:none; }

    .app{ position:relative; height:100dvh; overflow:hidden; max-width:430px; margin:0 auto; padding:0; }

    .screen{ position:absolute; inset:0; padding:20px 16px; padding-bottom:calc(130px + env(safe-area-inset-bottom)); overflow-y:auto; -webkit-overflow-scrolling:touch; display:none; }
    .screen.active{ display:block; }

    .bottom-dock{ bottom:calc(18px + env(safe-area-inset-bottom)); }

    .dock-item{ touch-action:manipulation; }

    /* ===== HOME DASHBOARD UI ===== */
    .topbar{ margin-top:6px; display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
    .brand{display:flex;flex-direction:column;gap:4px}
    .brand-title{ font-size:22px;font-weight:800;letter-spacing:0.2px }
    .brand-sub{ font-size:12px;color:rgba(255,255,255,0.55) }
    .pill{ padding:8px 12px; border-radius:999px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); backdrop-filter:blur(20px); font-size:12px; color:rgba(255,255,255,0.75); }

    .hero{ border-radius:26px; padding:18px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.07); box-shadow:0 18px 50px rgba(0,0,0,0.45); }
    .hero-row{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .hero-title{ font-size:13px;color:rgba(255,255,255,0.65) }
    .hero-value{ margin-top:6px;font-size:22px;font-weight:900 }
    .kpis{ display:flex;gap:10px;margin-top:12px }
    .kpi{ flex:1; padding:12px; border-radius:18px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.06); }
    .kpi .k-label{font-size:12px;color:rgba(255,255,255,0.55)}
    .kpi .k-val{margin-top:6px;font-size:14px;font-weight:800}
    .grid3{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:14px; }
    .mini-card{ padding:12px; border-radius:18px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.06); }
    .mini-card .m-label{font-size:11px;color:rgba(255,255,255,0.55)}
    .mini-card .m-val{margin-top:6px;font-size:16px;font-weight:900}
    .quick-actions{display:flex;gap:10px;margin-top:14px}
    .qa{ flex:1; padding:12px; border-radius:18px; background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.08); text-align:center; font-size:12px; color:rgba(255,255,255,0.92); user-select:none; -webkit-tap-highlight-color: transparent; }
    .qa:active{transform:scale(0.97)}
    .small-note{ margin-top:12px; font-size:12px; color:rgba(255,255,255,0.55); line-height:1.35; }

    /* ===== FINANCE v2 (plus + modal + lists) ===== */
    .screen-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .h-title{ font-size:26px; font-weight:900; letter-spacing:0.2px; }
    .icon-btn{ width:42px;height:42px; border-radius:14px; display:flex;align-items:center;justify-content:center; background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.09); box-shadow:0 14px 40px rgba(0,0,0,0.35); backdrop-filter:blur(18px); -webkit-tap-highlight-color: transparent; }
    .icon-plus{ font-size:22px; font-weight:900; line-height:1; color:rgba(255,255,255,0.92); }

    .fin-summary{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
    .fin-pill{ padding:14px; border-radius:20px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.07); }
    .fin-pill .lbl{font-size:12px;color:rgba(255,255,255,0.55) }
    .fin-pill .val{ margin-top:6px; font-size:18px; font-weight:900 }

    .list-card{ padding:14px; border-radius:22px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.07); margin-bottom:12px; }
    .list-title{ font-size:13px; color:rgba(255,255,255,0.62); margin-bottom:10px; }
    .list-row{ display:flex; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.06); }
    .list-row:last-child{ border-bottom:none }
    .list-row .name{ font-size:13px;color:rgba(255,255,255,0.9);max-width:70%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis }
    .list-row .amt{ font-size:13px;font-weight:900 }
    .muted{ color:rgba(255,255,255,0.45) }

    /* Modal (bottom sheet) */
    .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:flex-end; justify-content:center; z-index:9999; }
    .modal-overlay.show{ display:flex; }
    .sheet{ width:min(520px, 100%); border-top-left-radius:26px; border-top-right-radius:26px; padding:14px 14px 18px; background:rgba(18,22,32,0.92); border:1px solid rgba(255,255,255,0.08); backdrop-filter:blur(26px); box-shadow:0 -18px 60px rgba(0,0,0,0.55); }
    .sheet-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .sheet-title{font-size:14px;font-weight:900;color:rgba(255,255,255,0.9)}
    .sheet-close{ width:36px;height:36px;border-radius:12px; display:flex;align-items:center;justify-content:center; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); }
    .sheet-close:active{transform:scale(0.96)}
    .segment{ display:flex; gap:8px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.06); border-radius:18px; padding:6px; margin-bottom:12px; }
    .seg-btn{ flex:1; padding:10px 10px; border-radius:14px; text-align:center; font-size:12px; color:rgba(255,255,255,0.72); user-select:none; }
    .seg-btn.active{ background:rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.10); color:rgba(255,255,255,0.95); box-shadow:0 10px 24px rgba(0,0,0,0.35); }
    .form-grid{display:grid; gap:10px; margin-bottom:12px}
    .inp{ width:100%; padding:14px 14px; border-radius:18px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); color:#fff; outline:none; }
    .inp::placeholder{color:rgba(255,255,255,0.35)}
    .sheet-actions{ display:flex; gap:10px; align-items:center }
    .btn-primary{ flex:1; padding:14px 14px; border-radius:18px; background:rgba(0,255,157,0.16); border:1px solid rgba(0,255,157,0.22); color:rgba(255,255,255,0.95); font-weight:900; text-align:center; user-select:none; }
    .btn-primary.disabled{ opacity:0.45; filter:grayscale(0.2); }

    /* 3) Kalendarya: –¥–æ–±–∞–≤–∏–º —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤–æ–π —Å–µ–∫—Ü–∏–∏ */
    .calendar-card { padding: 16px; }
    .cal-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .cal-nav{ width:44px; height:44px; border-radius:14px; border:1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.06); color:#fff; font-size:22px; backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px); transition: transform .18s ease, background .18s ease; }
    .cal-nav:active{ transform: scale(.96); background: rgba(255,255,255,.09); }
    .cal-title{ text-align:center; line-height:1.1; }
    .cal-month{ font-weight:700; font-size:16px; }
    .cal-year{ opacity:.7; font-size:12px; margin-top:2px; }
    .cal-dow{ display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; opacity:.7; font-size:12px; margin-bottom:10px; }
    .cal-dow > div{ text-align:center; }
    .cal-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; }
    .cal-day{ height:44px; border-radius:16px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.06); background: rgba(255,255,255,.05); backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px); position:relative; user-select:none; -webkit-user-select:none; transition: transform .18s ease, background .18s ease, border-color .18s ease; }
    .cal-day:active{ transform: scale(.97); }
    .cal-day.muted{ opacity:.35; }
    .cal-day.done{ border-color: rgba(0,255,170,.35); background: rgba(0,255,170,.10); }
    .cal-day.has-note::after{ content:""; position:absolute; bottom:7px; width:6px; height:6px; border-radius:50%; background: rgba(255, 196, 0, .95); box-shadow: 0 0 12px rgba(255,196,0,.35); }

    .modal{ position:fixed; inset:0; z-index:9999; }
    .modal.hidden{ display:none; }
    .modal-backdrop{ position:absolute; inset:0; background: rgba(0,0,0,.45); }
    .modal-sheet{ position:absolute; left:12px; right:12px; bottom:12px; border-radius:22px; border:1px solid rgba(255,255,255,.10); background: rgba(20,24,34,.75); backdrop-filter: blur(22px); -webkit-backdrop-filter: blur(22px); padding:14px; }

    .input.cal-note{ width:100%; min-height:110px; resize:none; padding:12px 12px; border-radius:18px; border:1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.06); color:#fff; outline:none; margin: 6px 0 12px; }

  </style>
</head>
<body>
  <div class="app">

    <!-- HOME (screen-home) -->
    <div id="home" class="screen active">
      <div class="topbar">
        <div class="brand">
          <div class="brand-title">–§–ï–î–ï–†–ê–¶–ò–Ø</div>
          <div class="brand-sub">Executive Control ‚Ä¢ –õ–∏—á–Ω—ã–π –∫–æ–Ω—Ç—É—Ä</div>
        </div>
      </div>

      <div class="hero">
        <div class="hero-row">
          <div>
            <div class="hero-title">–§–∏–Ω–∞–Ω—Å—ã ‚Äî —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</div>
            <div class="hero-value" id="heroProfit">‚ÇΩ 0</div>
            <div class="small-note" id="heroPercent">–ù–∞–∂–º–∏ –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–º—É ‚Üí –ø–æ–∫–∞–∂—É –ø—Ä–æ—Ü–µ–Ω—Ç—ã</div>
          </div>
          <div style="width:170px;">
            <canvas id="chart" style="height:160px;"></canvas>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="k-label">–î–æ—Ö–æ–¥</div>
            <div class="k-val green" id="kIncome">‚ÇΩ 0</div>
          </div>
          <div class="kpi">
            <div class="k-label">–†–∞—Å—Ö–æ–¥</div>
            <div class="k-val red" id="kExpense">‚ÇΩ 0</div>
          </div>
          <div class="kpi">
            <div class="k-label">–ú–∞—Ä–∂–∞</div>
            <div class="k-val orange" id="kMargin">0%</div>
          </div>
        </div>
      </div>

      <div class="grid3">
        <div class="mini-card">
          <div class="m-label">–í —Ä–∞–±–æ—Ç–µ</div>
          <div class="m-val orange" id="mWork">0</div>
        </div>
        <div class="mini-card">
          <div class="m-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
          <div class="m-val green" id="mDone">0</div>
        </div>
        <div class="mini-card">
          <div class="m-label">–ó–∞–¥–µ—Ä–∂–∫–∏</div>
          <div class="m-val red" id="mDelay">0</div>
        </div>
      </div>
    </div>

    <!-- 1) –≠–∫—Ä–∞ÃÅ–Ω –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω screen-calendar) -->
    <section id="screen-calendar" class="screen hidden" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å">
      <div class="screen-head">
        <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h1>
      </div>

      <div class="card calendar-card">
        <div class="cal-top">
          <button class="cal-nav" id="calPrev" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü">‚Äπ</button>

          <div class="cal-title">
            <div id="calMonthLabel" class="cal-month">–ú–∞—Ä—Ç</div>
            <div id="calYearLabel" class="cal-year">2026</div>
          </div>

          <button class="cal-nav" id="calNext" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü">‚Ä∫</button>
        </div>

        <div class="cal-dow">
          <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
        </div>

        <div id="calGrid" class="cal-grid"></div>
      </div>
    </section>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –∑–∞–º–µ—Ç–∫–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
    <div id="calNoteModal" class="modal hidden" role="dialog" aria-modal="true">
      <div class="modal-backdrop" data-close="1"></div>
      <div class="modal-sheet">
        <div class="modal-head">
          <div class="modal-title" id="calNoteTitle">–ó–∞–º–µ—Ç–∫–∞</div>
          <button class="icon-btn" id="calNoteClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>

        <textarea id="calNoteText" class="input cal-note" placeholder="–ù–∞–ø–∏—à–∏ –∑–∞–º–µ—Ç–∫—É..."></textarea>

        <div class="modal-actions">
          <button class="btn primary" id="calNoteSave">–ì–æ—Ç–æ–≤–æ</button>
          <button class="btn" id="calNoteDelete">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã -->
    <div id="screen-finance" class="screen hidden">
      <!-- —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –§–∏–Ω–∞–Ω—Å—ã -->
      <div class="screen-header">
        <div class="h-title">–§–∏–Ω–∞–Ω—Å—ã</div>
        <div class="icon-btn" id="finAddBtn" title="–î–æ–±–∞–≤–∏—Ç—å">
          <div class="icon-plus">+</div>
        </div>
      </div>

      <div class="fin-summary">
        <div class="fin-pill">
          <div class="lbl">–î–æ—Ö–æ–¥</div>
          <div class="val green" id="sumIncome">‚ÇΩ 0</div>
        </div>
        <div class="fin-pill">
          <div class="lbl">–†–∞—Å—Ö–æ–¥</div>
          <div class="val red" id="sumExpense">‚ÇΩ 0</div>
        </div>
      </div>

      <div class="list-card">
        <div class="list-title">–î–æ—Ö–æ–¥—ã ‚Äî –æ—Ç –∫–æ–≥–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</div>
        <div id="incomeList" class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
      </div>

      <div class="list-card">
        <div class="list-title">–†–∞—Å—Ö–æ–¥—ã ‚Äî –∫–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª—è–ª</div>
        <div id="expenseList" class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
      </div>
    </div>

    <div id="screen-objects" class="screen hidden">
      <h1>–û–±—ä–µ–∫—Ç—ã</h1>
      <div class="card">
        <textarea id="objectInput" placeholder="–ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç"></textarea>
        <button onclick="addObject()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div id="objectList"></div>
    </div>

    <div id="screen-calendar-alt" class="screen hidden">
      <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å (–ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –¥—É–±–ª–∏–∫–∞—Ç)</h1>
      <!-- –º–æ–∂–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ -->
    </div>

    <div id="screen-decisions" class="screen hidden">
      <h1>–†–µ—à–µ–Ω–∏—è</h1>
      <div class="card">
        <textarea id="decisionInput" placeholder="–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ"></textarea>
        <button onclick="addDecision()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <div id="decisionList"></div>
    </div>

  </div>

  <div class="bottom-dock" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
    <div class="dock-item active" onclick="switchTab('home', this)">
      <div class="dock-icon">üë§</div>
      <div class="dock-label">–ì–ª–∞–≤–Ω–∞—è</div>
    </div>
    <div class="dock-item" onclick="switchTab('screen-finance', this)">
      <div class="dock-icon">üí∞</div>
      <div class="dock-label">–§–∏–Ω–∞–Ω—Å—ã</div>
    </div>
    <div class="dock-item" onclick="switchTab('screen-objects', this)">
      <div class="dock-icon">üí¨</div>
      <div class="dock-label">–û–±—ä–µ–∫—Ç—ã</div>
    </div>
    <div class="dock-item" onclick="switchTab('screen-calendar', this)">
      <div class="dock-icon">üìÖ</div>
      <div class="dock-label">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
    </div>
    <div class="dock-item" onclick="switchTab('screen-decisions', this)">
      <div class="dock-icon">üß†</div>
      <div class="dock-label">–†–µ—à–µ–Ω–∏—è</div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand(); tg?.ready();

    // State (–º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –¥–∞–Ω–Ω—ã–µ)
    let objects = JSON.parse(localStorage.getItem("objects"))||[];
    let finances = JSON.parse(localStorage.getItem("finances"))||[];
    let decisions = JSON.parse(localStorage.getItem("decisions"))||[];

    // Finance Entries v2
    let financeEntries = JSON.parse(localStorage.getItem("fed_fin_entries") || "[]");

    // migrate old format (–µ—Å–ª–∏ –µ—Å—Ç—å)
    (function migrateOldFinances(){
      try{
        const old = JSON.parse(localStorage.getItem("finances") || "null");
        if(Array.isArray(old) && old.length && financeEntries.length === 0){
          old.forEach(x=>{
            const inc = Number(x.income||0);
            const exp = Number(x.expense||0);
            const ts = x.ts || Date.now();
            if(inc>0){
              financeEntries.push({id: crypto?.randomUUID?.() || String(Math.random()), type:"income", counterparty:(x.from||x.object||"–ù–µ —É–∫–∞–∑–∞–Ω–æ"), note:"", amount:inc, ts});
            }
            if(exp>0){
              financeEntries.push({id: crypto?.randomUUID?.() || String(Math.random()), type:"expense", counterparty:(x.to||x.object||"–ù–µ —É–∫–∞–∑–∞–Ω–æ"), note:"", amount:exp, ts});
            }
          });
          localStorage.setItem("fed_fin_entries", JSON.stringify(financeEntries));
        }
      }catch(e){}
    })();

    function saveFinanceEntries(){ localStorage.setItem("fed_fin_entries", JSON.stringify(financeEntries)); }

    function fmtRub(n){
      return "‚ÇΩ " + Number(n||0).toLocaleString("ru-RU", {maximumFractionDigits:0});
    }

    function escapeHtml(str){
      return String(str||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===== Calendar (FEDERACIA) =====
    const CAL_STORAGE_MARKS = "FED_CAL_MARKS";   // { "YYYY-MM-DD": true }
    const CAL_STORAGE_NOTES = "FED_CAL_NOTES";   // { "YYYY-MM-DD": "text" }

    let calView = (function(){
      const d = new Date();
      return { y: d.getFullYear(), m: d.getMonth() }; // m 0..11
    })();

    let calMarks = safeJson(localStorage.getItem(CAL_STORAGE_MARKS), {});
    let calNotes = safeJson(localStorage.getItem(CAL_STORAGE_NOTES), {});

    let calPressTimer = null;
    let calPressedKey = null;

    function safeJson(str, fallback){
      try{ return str ? JSON.parse(str) : fallback; } catch(e){ return fallback; }
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function dateKey(y,m,day){ return `${y}-${pad2(m+1)}-${pad2(day)}`; }

    function monthNameRu(m){
      const names = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
      return names[m] || "";
    }

    function renderCalendar(){
      const grid = document.getElementById("calGrid");
      const ml = document.getElementById("calMonthLabel");
      const yl = document.getElementById("calYearLabel");
      if(!grid || !ml || !yl) return;

      ml.textContent = monthNameRu(calView.m);
      yl.textContent = String(calView.y);

      grid.innerHTML = "";

      const first = new Date(calView.y, calView.m, 1);
      const last = new Date(calView.y, calView.m + 1, 0);
      const daysInMonth = last.getDate();

      // –ü–Ω=0..–í—Å=6
      const jsDow = first.getDay(); // –í—Å=0..–°–±=6
      const startOffset = (jsDow + 6) % 7; // –ø–µ—Ä–µ–≤–æ–¥–∏–º: –ü–Ω=0

      // –¥–æ–±–∏–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö
      const prevLast = new Date(calView.y, calView.m, 0).getDate();
      for(let i=0; i<startOffset; i++){
        const day = prevLast - (startOffset - 1 - i);
        const cell = makeDayCell(calView.y, calView.m - 1, day, true);
        grid.appendChild(cell);
      }

      // —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
      for(let day=1; day<=daysInMonth; day++){
        const cell = makeDayCell(calView.y, calView.m, day, false);
        grid.appendChild(cell);
      }

      // –¥–æ–±–∏–≤–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–æ —Ä–æ–≤–Ω–æ–π —Å–µ—Ç–∫–∏
      const total = startOffset + daysInMonth;
      const tail = (7 - (total % 7)) % 7;
      for(let day=1; day<=tail; day++){
        const cell = makeDayCell(calView.y, calView.m + 1, day, true);
        grid.appendChild(cell);
      }
    }

    function normalizeYM(y, m){
      const d = new Date(y, m, 1);
      return { y: d.getFullYear(), m: d.getMonth() };
    }

    function makeDayCell(y, m, day, muted){
      const nm = normalizeYM(y,m);
      const key = dateKey(nm.y, nm.m, day);

      const el = document.createElement("div");
      el.className = "cal-day" + (muted ? " muted" : "");
      el.textContent = String(day);
      el.dataset.key = key;

      if(calMarks[key]) el.classList.add("done");
      if(calNotes[key] && String(calNotes[key]).trim()) el.classList.add("has-note");

      // tap + long press
      el.addEventListener("touchstart", (e)=> startPress(key, el), {passive:true});
      el.addEventListener("touchend", endPress, {passive:true});
      el.addEventListener("touchcancel", cancelPress, {passive:true});

      el.addEventListener("mousedown", ()=> startPress(key, el));
      el.addEventListener("mouseup", endPress);
      el.addEventListener("mouseleave", cancelPress);

      return el;
    }

    function startPress(key, el){
      cancelPress();
      calPressedKey = key;

      calPressTimer = setTimeout(()=>{
        // long press -> note
        openCalNote(key);
        calPressTimer = null;
      }, 450);
    }

    function endPress(){
      if(calPressTimer){
        clearTimeout(calPressTimer);
        calPressTimer = null;
        toggleCalDone(calPressedKey);
      }
      calPressedKey = null;
    }

    function cancelPress(){
      if(calPressTimer){
        clearTimeout(calPressTimer);
        calPressTimer = null;
      }
      calPressedKey = null;
    }

    function toggleCalDone(key){
      if(!key) return;
      calMarks[key] = !calMarks[key];
      localStorage.setItem(CAL_STORAGE_MARKS, JSON.stringify(calMarks));
      renderCalendar();
    }

    function openCalNote(key){
      const modal = document.getElementById("calNoteModal");
      const title = document.getElementById("calNoteTitle");
      const text = document.getElementById("calNoteText");
      if(!modal || !title || !text) return;

      title.textContent = `–ó–∞–º–µ—Ç–∫–∞ ‚Ä¢ ${key}`;
      text.value = calNotes[key] || "";
      modal.dataset.key = key;

      modal.classList.remove("hidden");
    }

    function closeCalNote(){
      const modal = document.getElementById("calNoteModal");
      if(!modal) return;
      modal.classList.add("hidden");
      modal.dataset.key = "";
    }

    function bindCalendarUI(){
      const prev = document.getElementById("calPrev");
      const next = document.getElementById("calNext");

      if(prev) prev.addEventListener("click", ()=>{
        const d = new Date(calView.y, calView.m - 1, 1);
        calView.y = d.getFullYear(); calView.m = d.getMonth();
        renderCalendar();
      });

      if(next) next.addEventListener("click", ()=>{
        const d = new Date(calView.y, calView.m + 1, 1);
        calView.y = d.getFullYear(); calView.m = d.getMonth();
        renderCalendar();
      });

      const modal = document.getElementById("calNoteModal");
      const close = document.getElementById("calNoteClose");
      const save = document.getElementById("calNoteSave");
      const del = document.getElementById("calNoteDelete");

      if(close) close.addEventListener("click", closeCalNote);

      if(modal){
        modal.addEventListener("click",(e)=>{
          if(e.target && e.target.dataset && e.target.dataset.close === "1") closeCalNote();
        });
      }

      if(save) save.addEventListener("click", ()=>{
        const key = (modal && modal.dataset.key) ? modal.dataset.key : "";
        const text = document.getElementById("calNoteText");
        if(!key || !text) return;

        const val = String(text.value || "").trim();
        if(val){
          calNotes[key] = val;
        }else{
          delete calNotes[key];
        }
        localStorage.setItem(CAL_STORAGE_NOTES, JSON.stringify(calNotes));
        closeCalNote();
        renderCalendar();
      });

      if(del) del.addEventListener("click", ()=>{
        const key = (modal && modal.dataset.key) ? modal.dataset.key : "";
        if(!key) return;
        delete calNotes[key];
        localStorage.setItem(CAL_STORAGE_NOTES, JSON.stringify(calNotes));
        closeCalNote();
        renderCalendar();
      });
    }

    // Init
    document.addEventListener("DOMContentLoaded", ()=> {
      bindCalendarUI();
      renderCalendar();
      // –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –µ—â–µ —Ñ—É–Ω—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–¥–µ—Å—å
    });

    // -----------------------------
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏/–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    // –ü—Ä–∏–≤—è–∂–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –∫ –∫–Ω–æ–ø–∫–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ–∑–∂–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    // -----------------------------
  </script>

</body>
</html>
```
